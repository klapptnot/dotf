#!/usr/bin/bash
# ðŸ”— https://github.com/klapptnot/dotf

declare -rA THEME_KEY_IMAGE=(
  ["light"]="picture-uri"
  ["dark"]="picture-uri-dark"
)

function main {
  readonly SOCKET_TIMEOUT="${1:-0}"
  for cmd in hyprpaper gsettings hyprctl jq; do
    if ! command -v "${cmd}" &> /dev/null; then
      printf '%s is not an executable, or is not accessible\n' "${cmd}" >&2
      return 1
    fi
  done

  local bg_key value
  read -r bg_key < <(dconf read /org/gnome/desktop/interface/color-scheme) || bg_key="'default'"
  bg_key="${bg_key:8:-1}" # 'light' | 'dark' | ''
  bg_key="${THEME_KEY_IMAGE[${bg_key:-light}]}"

  if ! read -r value < <(gsettings get org.gnome.desktop.background "${bg_key}"); then
    printf "Failed to read gsettings background\n" >&2
    return 1
  fi
  # from 'file:///path/to/file' to /path/to/file
  value="${value:8:-1}"

  if [ "${1}" == 'query' ]; then
    printf '%s\n' "${value}"
    return
  fi

  if ! wait-for-socket; then
    printf 'Use "SOCKET_TIMEOUT=10 use-gnome-wallpaper [params]" to change timeout\n'
    printf 'hyprpaper socket is not found after %s seconds. Exiting...\n' "${SOCKET_TIMEOUT}" 1>&2
    return
  fi

  mapfile -t monitors < <(hyprctl -j monitors all | jq -rM '.[] | .name')
  trap 'kill -15 0' EXIT SIGINT

  # set to a different value, then after starting the monitor
  # it triggers immediately as we set the old value again
  gsettings set org.gnome.desktop.background "${bg_key}" "${value}"
  {
    sleep 0.1
    gsettings set org.gnome.desktop.background "${bg_key}" "file://${value}"
  } &
  disown "${!}"

  local current_wallpaper="::none::none"
  {
    gsettings monitor org.gnome.desktop.interface color-scheme &
    gsettings monitor org.gnome.desktop.background
  } \
    | while IFS=': ' read -r key value; do
      value="${value:8:-1}" # 'light' | 'dark' | '' | /path/to/file

      if [[ "${key}" == "color-scheme" ]]; then
        [ "${bg_key}" == "${THEME_KEY_IMAGE[${value:-light}]}" ] && continue
        bg_key="${THEME_KEY_IMAGE[${value:-light}]}"

        if ! read -r value < <(gsettings get org.gnome.desktop.background "${bg_key}"); then
          printf "Failed to read gsettings background: %s\n" "${bg_key}" >&2
          continue
        fi

        value="${value:8:-1}" # /path/to/file
      else
        [ "${key}" != "${bg_key}" ] && continue
      fi

      [ "${value}" == "${current_wallpaper}" ] && continue
      current_wallpaper="${value}"

      for monitor in "${monitors[@]}"; do
        if ! hyprctl-wrapper hyprpaper wallpaper "${monitor}, ${value}"; then
          printf "Failed to set wallpaper for monitor: %s\n" "${monitor}" >&2
        fi
      done
    done
}

function wait-for-socket {
  test "${SOCKET_TIMEOUT}" == '0' && return 0

  for ((i = 0; i <= SOCKET_TIMEOUT; i++)); do
    test -S "${XDG_RUNTIME_DIR}/hypr/${HYPRLAND_INSTANCE_SIGNATURE}/.hyprpaper.sock" && return 0
    sleep 1
  done
  return 1
}

function hyprctl-wrapper {
  printf '$ hyprctl %s\n' "${*@Q}"
  hyprctl "${@}"
} 2>&1

main "${@}"

#!/usr/bin/bash
# ðŸ”— https://github.com/klapptnot/dotf

function battery_data_get {
  local key="${1}"
  case "${key}" in
    'icon_name')
      [ "${POWER_SUPPLY_STATUS}" == "Charging" ] && local icon="-charging"
      printf 'battery-%03d%s' "$(((POWER_SUPPLY_CAPACITY / 10) * 10))" "${icon}"
      ;;
    'icon')
      [ "${POWER_SUPPLY_STATUS}" == "Charging" ] && printf 'ï‡¦' && return
      ((POWER_SUPPLY_CAPACITY > 90)) && printf 'ó°¹' && return
      ((POWER_SUPPLY_CAPACITY > 80)) && printf 'ó°‚‚' && return
      ((POWER_SUPPLY_CAPACITY > 70)) && printf 'ó°‚' && return
      ((POWER_SUPPLY_CAPACITY > 60)) && printf 'ó°‚€' && return
      ((POWER_SUPPLY_CAPACITY > 50)) && printf 'ó°¿' && return
      ((POWER_SUPPLY_CAPACITY > 40)) && printf 'ó°¾' && return
      ((POWER_SUPPLY_CAPACITY > 30)) && printf 'ó°½' && return
      ((POWER_SUPPLY_CAPACITY > 20)) && printf 'ó°¼' && return
      ((POWER_SUPPLY_CAPACITY > 10)) && printf 'ó°»' && return
      ((POWER_SUPPLY_CAPACITY > 00)) && printf 'ó°º' && return
      ;;
    *)
      local power_supply_key="POWER_SUPPLY_${key^^}"
      if [ -z "${!power_supply_key@A}" ]; then
        printf 'Unknown key: %s\n' "${key^^}" >&2
        return
      fi
      printf '%s' "${!power_supply_key}"
      ;;
  esac
}

function main {
  local format_it='\{([a-z_]+)\}'
  local what="${1:-"{icon} {capacity}% {status}"}"
  local battery_file=(/sys/class/power_supply/BAT*/uevent)
  # shellcheck disable=SC1090
  source <(cat "${battery_file[0]}")

  while [[ "${what}" =~ ${format_it} ]]; do
    IFS=$'\n' read -r res < <(battery_data_get "${BASH_REMATCH[1]}")
    what="${what//"${BASH_REMATCH[0]}"/"${res}"}"
  done

  printf '%s\n' "${what}"
}

main "${@}"

get-env() { echo "${!1}"; }
set-env() { export "$1=$2"; }
unset-env() { unset "$1"; }

_carapace_completer() {
  export COMP_LINE
  export COMP_POINT
  export COMP_TYPE
  export COMP_WORDBREAKS

  declare -x CARAPACE_SHELL=bash
  declare -x CARAPACE_SHELL_BUILTINS="$(compgen -b)"
  declare -x CARAPACE_SHELL_FUNCTIONS="$(compgen -A function)"

  local command="${COMP_WORDS[0]}" nospace data compline="${COMP_LINE:0:${COMP_POINT}}"

  data=$(echo "${compline}''" | xargs carapace "${command}" bash 2> /dev/null)
  if [ $? -eq 1 ]; then
    data=$(echo "${compline}'" | xargs carapace "${command}" bash 2> /dev/null)
    if [ $? -eq 1 ]; then
      data=$(echo "${compline}\"" | xargs carapace "${command}" bash 2> /dev/null)
    fi
  fi

  IFS=$'\001' read -r -d '' nospace data <<< "${data}"
  mapfile -t COMPREPLY < <(echo "${data}")
  unset COMPREPLY[-1]

  [ "${nospace}" = true ] && compopt -o nospace
  local IFS=$'\n'
  [[ "${COMPREPLY[*]}" == "" ]] && COMPREPLY=() # fix for mapfile creating a non-empty array from empty command output
}

complete -o noquote -F _carapace_completer "acpi" "acpid" "adb" "age" "agg" "alsamixer" "ant" "apk" "aplay" "apropos" "apt" "apt-cache" "apt-get" "ar" "archlinux-java" "arecord" "aria2c" "artisan" "asciinema" "autoconf" "avdmanager" "awk" "aws" "az" "baobab" "base32" "base64" "basename" "bash" "bash-language-server" "bat" "batdiff" "batgrep" "batman" "bats" "bc" "benthos" "black" "bloop" "bluetoothctl" "boundary" "brew" "brotli" "bru" "btop" "buildctl" "bun" "bunx" "but" "cal" "calibre" "capslock" "carapace" "cargo" "cargo-clippy" "cargo-fmt" "cargo-metadata" "cargo-rm" "cargo-set-version" "cargo-upgrade" "cargo-watch" "cat" "cfdisk" "charm" "chcpu" "chdman" "cheese" "chgrp" "chmod" "chown" "chpasswd" "chroma" "chromium" "chroot" "chsh" "circleci" "cksum" "clamav-config" "clamav-milter" "clambc" "clamconf" "clamd" "clamdscan" "clamdtop" "clamonacc" "clamscan" "clamsubmit" "cmus" "code" "code-insiders" "codecov" "comm" "conda" "conda-content-trust" "conda-env" "conky" "consul" "coredumpctl" "cp" "csplit" "csview" "cura" "curl" "cut" "d2" "dagger" "darktable" "darktable-cli" "dart" "date" "dbt" "dc" "dd" "deadcode" "delta" "deno" "devbox" "df" "dfc" "dict" "diff" "diff3" "dig" "dir" "dircolors" "direnv" "dirname" "dive" "dlv" "dmenu" "dmesg" "dms" "dngconverter" "dnsmasq" "doas" "docker" "docker-buildx" "docker-compose" "docker-scan" "dockerd" "doctl" "doing" "dos2unix" "downgrade" "dpkg" "du" "ebook-convert" "egrep" "electron" "elvish" "env" "envsubst" "exa" "expand" "expr" "eza" "faas-cli" "factor" "fakechroot" "fakeroot" "fastfetch" "fc-cache" "fc-cat" "fc-conflist" "fc-list" "fd" "fdisk" "ffmpeg" "fgrep" "file" "find" "firefox" "fish" "flatpak" "flutter" "fmt" "fnm" "fold" "foot" "free" "freeze" "ftp" "ftpd" "fury" "fzf" "gatsby" "gcloud" "gdb" "gdown" "gdu" "get-env" "gftp" "gh" "gh-copilot" "gh-dash" "ghostty" "gimp" "git" "git-abort" "git-alias" "git-archive-file" "git-authors" "git-browse" "git-browse-ci" "git-clang-format" "git-clear" "git-clear-soft" "git-coauthor" "git-extras" "git-info" "git-standup" "git-unlock" "git-utimes" "gitk" "gitui" "glab" "glow" "gm" "gnome-keyring" "gnome-keyring-daemon" "gnome-maps" "gnome-terminal" "go" "go-carpet" "go-tool-asm" "go-tool-buildid" "go-tool-cgo" "go-tool-compile" "go-tool-covdata" "go-tool-cover" "go-tool-dist" "go-tool-doc" "go-tool-fix" "go-tool-link" "go-tool-mockgen" "go-tool-nm" "go-tool-objdump" "go-tool-pack" "gocyclo" "gofmt" "goimports" "golangci-lint" "gonew" "google-chrome" "gopls" "goreleaser" "goweight" "gparted" "gpasswd" "gpg" "gpg-agent" "gradle" "grep" "groupadd" "groupdel" "groupmems" "groupmod" "groups" "grype" "gsa" "gulp" "gum" "gunzip" "gzip" "halt" "head" "helix" "helm" "helmsman" "hexchat" "hexdump" "hostid" "hostname" "htop" "http" "https" "hugetop" "hugo" "hurl" "hwinfo" "hx" "i3" "i3-scrot" "i3exit" "i3lock" "i3status" "i3status-rs" "id" "imv" "inkscape" "inshellisense" "install" "ion" "jar" "java" "javac" "jj" "join" "journalctl" "jq" "julia" "just" "kak" "kak-lsp" "kill" "killall" "kitten" "kitty" "kmonad" "kompose" "kotlin" "kotlinc" "ktlint" "kubeadm" "kubectl" "kubeseal" "last" "lastb" "lastlog" "lazygit" "lf" "light" "lightdm" "link" "ln" "lnav" "lncrawl" "locale" "localectl" "logname" "ls" "lsb_release" "lsblk" "lsclocks" "lscpu" "lsfd" "lsirq" "lslocks" "lslogins" "lsmem" "lsns" "lsusb" "lua" "lzcat" "lzma" "magick" "make" "makepkg" "man" "marp" "mcomix" "md5sum" "mdbook" "meld" "melt" "micro" "minikube" "mitmproxy" "mix" "mkcert" "mkdir" "mkfifo" "mkfs" "mknod" "mkswap" "mktemp" "modinfo" "modprobe" "molecule" "more" "mosh" "mount" "mousepad" "mpv" "mv" "mvn" "n-m3u8dl-re" "nano" "nc" "ncdu" "neomutt" "netcat" "newman" "newrelic" "nfpm" "ng" "nice" "nilaway" "nix" "nix-build" "nix-channel" "nix-instantiate" "nix-shell" "nixos-rebuild" "nl" "nmcli" "node" "nohup" "nomad" "npm" "nproc" "ntpd" "nu" "numfmt" "nvim" "od" "ollama" "openscad" "openssl" "optipng" "packer" "pacman" "pacman-conf" "pacman-db-upgrade" "pacman-key" "pacman-mirrors" "palemoon" "pamac" "pandoc" "paru" "pass" "passwd" "paste" "patch" "pathchk" "patool" "pcmanfm" "pdfattach" "pdfdetach" "pdffonts" "pdfimages" "pdfinfo" "pdfseparate" "pdfsig" "pdftocairo" "pdftohtml" "pdftoppm" "pdftops" "pdftotext" "pdfunite" "pgrep" "php" "picard" "pidof" "pidwait" "pigz" "ping" "pinky" "pip" "pkgsite" "pkill" "pmap" "pngcheck" "pnpm" "podman" "poweroff" "powertop" "pprof" "pr" "present" "prettybat" "prettyping" "printenv" "procs" "ps" "ptx" "pulumi" "pwd" "pwdx" "python" "qmk" "qpdf" "qrencode" "qutebrowser" "ramalama" "ranger" "readlink" "reboot" "redis-cli" "rename" "restic" "resume-cli" "rg" "rifle" "ripsecrets" "rm" "rmdir" "rmmod" "rsync" "run0" "rust-analyzer" "rustc" "rustdoc" "rustup" "saw" "scp" "script" "scriptlive" "scriptreplay" "scrot" "sd" "sdkmanager" "sed" "semver" "seq" "serie" "set-env" "sftp" "sha1sum" "sha224sum" "sha256sum" "sha384sum" "sha512sum" "showkey" "shred" "shutdown" "slabtop" "sleep" "slides" "soft" "sort" "speedtest-cli" "split" "sqlite3" "ssh" "ssh-agent" "ssh-copy-id" "ssh-keygen" "st" "starship" "stat" "staticcheck" "strings" "stty" "su" "sudo" "sudoedit" "sudoreplay" "sulogin" "sum" "supervisorctl" "supervisord" "svg-term" "svgcleaner" "sway" "swaybar" "swaybg" "swayidle" "swaylock" "swaymsg" "swaynag" "syft" "sync" "sysctl" "systemctl" "systemd-analyze" "tac" "tail" "taplo" "tar" "task" "tea" "tee" "telnet" "templ" "termux-apt-repo" "terraform" "terraform-ls" "terragrunt" "terramate" "tesseract" "tig" "timeout" "tinygo" "tldr" "tload" "tmate" "tmux" "tofu" "toit.lsp" "toit.pkg" "top" "tor-browser" "tor-gencert" "tor-print-ed-signing-cert" "tor-resolve" "torsocks" "touch" "tox" "tr" "traefik" "transmission-cli" "transmission-create" "transmission-daemon" "transmission-edit" "transmission-remote" "transmission-show" "tree" "truncate" "ts" "tsc" "tsh" "tshark" "tsort" "tty" "ttyd" "turbo" "typst" "ufw" "umount" "uname" "unbrotli" "unexpand" "uniq" "unlink" "unlzma" "unpigz" "unset-env" "unxz" "unzip" "upower" "uptime" "upx" "useradd" "userdel" "usermod" "users" "vagrant" "vault" "vdir" "vercel" "vhs" "vi" "viewnior" "vim" "visudo" "viu" "vivid" "vlc" "vmstat" "volta" "w" "watch" "watchexec" "watchgnupg" "waypoint" "wc" "wezterm" "wget" "whereis" "which" "who" "whoami" "wine" "wineboot" "winepath" "wineserver" "winetricks" "wire" "wireshark" "wishlist" "wl-mirror" "woeusb" "xargs" "xbacklight" "xbps-alternatives" "xbps-checkvers" "xbps-create" "xbps-dgraph" "xbps-digest" "xbps-fbulk" "xbps-fetch" "xbps-install" "xbps-pkgdb" "xbps-query" "xbps-reconfigure" "xbps-remove" "xbps-rindex" "xbps-uchroot" "xbps-uhelper" "xbps-uunshare" "xclip" "xdotool" "xh" "xonsh" "xz" "xzcat" "yarn" "yay" "yes" "yj" "youtube-dl" "yt-dlp" "zathura" "zcat" "zip" "zoxide"
